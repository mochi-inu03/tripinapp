<%= form_with model: @spot, local: true do |f| %>

  <!-- ğŸ”½ â‘  ä½æ‰€æ¤œç´¢æ¬„ï¼ˆAutocomplete Service ä½¿ç”¨ï¼‰ -->
  <div style="margin-bottom: 10px;">
    <label for="address-input">ğŸ“ ä½æ‰€æ¤œç´¢</label><br>
    <input id="address-input" type="text" placeholder="ä¾‹: æ±äº¬é§…" style="width: 300px; padding: 5px;">
  </div>

  <!-- ğŸ”½ ç·¯åº¦ãƒ»çµŒåº¦ hidden_fieldï¼ˆDBä¿å­˜ç”¨ï¼‰ -->
  <%= f.hidden_field :latitude, id: 'latitude' %>
  <%= f.hidden_field :longitude, id: 'longitude' %>

  <!-- ğŸ”½ â‘¡ ã‚¿ã‚¤ãƒˆãƒ« -->
  <div style="margin-bottom: 10px;">
    <%= f.label :title %><br>
    <%= f.text_field :title, style: "width: 300px; padding: 5px;" %>
  </div>

  <!-- ğŸ”½ â‘¢ èª¬æ˜ -->
  <div style="margin-bottom: 10px;">
    <%= f.label :description %><br>
    <%= f.text_area :description, rows: 4, style: "width: 300px; padding: 5px;" %>
  </div>

  <!-- ğŸ”½ â‘£ ç”»åƒ -->
  <div style="margin-bottom: 10px;">
    <%= f.label :image %><br>
    <%= f.file_field :image %>
  </div>

  <!-- ğŸ”½ â‘¤ ã‚«ãƒ†ã‚´ãƒª -->
  <div style="margin-bottom: 10px;">
    <%= f.label :category_id, "ã‚«ãƒ†ã‚´ãƒª" %><br>
    <%= f.collection_select :category_id, Category.all, :id, :name, prompt: 'é¸æŠã—ã¦ãã ã•ã„' %>
  </div>

  <!-- ğŸ”½ â‘¥ Google Map -->
  <div id="map" style="height: 400px; margin-bottom: 10px; border: 1px solid #ccc;"></div>

  <!-- ğŸ”½ â‘¦ æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆå†™çœŸï¼‹ä½æ‰€ï¼‹åå‰ï¼‹å–¶æ¥­æ™‚é–“ï¼‹é›»è©±ï¼‹Webï¼‰ -->
  <div id="info-panel" style="padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; margin-bottom: 20px;">
    <strong>æ¤œç´¢çµæœ:</strong><br>

    <!-- å†™çœŸè¡¨ç¤º -->
    <div id="info-photo" style="margin-bottom: 10px;">
      <img id="place-photo" src="" alt="å ´æ‰€ã®å†™çœŸ" style="max-width: 100%; display: none;">
    </div>

    <!-- ã‚¹ãƒãƒƒãƒˆå -->
    <div id="info-name" style="margin-bottom: 5px;">åå‰: æœªé¸æŠ</div>

    <!-- ä½æ‰€ -->
    <div id="info-address" style="margin-bottom: 5px;">ä½æ‰€: æœªé¸æŠ</div>

    <!-- å–¶æ¥­æ™‚é–“ -->
    <div id="info-hours" style="margin-bottom: 5px;">å–¶æ¥­æ™‚é–“: æœªå–å¾—</div>

    <!-- é›»è©±ç•ªå· -->
    <div id="info-phone" style="margin-bottom: 5px;">é›»è©±ç•ªå·: æœªå–å¾—</div>

    <!-- Webã‚µã‚¤ãƒˆ -->
    <div id="info-website" style="margin-bottom: 5px;">Webã‚µã‚¤ãƒˆ: æœªå–å¾—</div>
  </div>

  <!-- ğŸ”½ â‘§ æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
  <%= f.submit "æŠ•ç¨¿ã™ã‚‹", style: "padding: 10px 20px; font-size: 16px;" %>

<% end %>

<!-- ğŸ”½ JSéƒ¨åˆ† -->
<script>
  let map;
  let marker;
  let autocomplete;
  let placesService;

  function initMap() {
    const initialPosition = { lat: 35.6803997, lng: 139.7690174 }; // æ±äº¬
    map = new google.maps.Map(document.getElementById('map'), {
      center: initialPosition,
      zoom: 10
    });

    marker = new google.maps.Marker({
      map: map,
      position: initialPosition
    });

    // Autocomplete Service è¨­å®š
    const input = document.getElementById('address-input');
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: [
        'geometry',
        'formatted_address',
        'place_id',
        'photos',
        'name',
        'opening_hours',
        'formatted_phone_number',
        'website'
      ]
    });

    // Places Service åˆæœŸåŒ–
    placesService = new google.maps.places.PlacesService(map);

    // place_changed ã‚¤ãƒ™ãƒ³ãƒˆ
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();

      if (!place.geometry || !place.geometry.location) {
        alert('å ´æ‰€ã®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }

      const location = place.geometry.location;

      // ãƒãƒƒãƒ—ã¨ãƒ”ãƒ³æ›´æ–°
      map.setCenter(location);
      marker.setPosition(location);

      // ç·¯åº¦ãƒ»çµŒåº¦ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆï¼ˆDBä¿å­˜ç”¨ï¼‰
      document.getElementById('latitude').value = location.lat();
      document.getElementById('longitude').value = location.lng();

      // ã‚¹ãƒãƒƒãƒˆå
      document.getElementById('info-name').textContent = 'åå‰: ' + (place.name || 'æœªå–å¾—');

      // ä½æ‰€
      document.getElementById('info-address').textContent = 'ä½æ‰€: ' + (place.formatted_address || 'æœªå–å¾—');

      // å–¶æ¥­æ™‚é–“
      if (place.opening_hours && place.opening_hours.weekday_text) {
        document.getElementById('info-hours').textContent = 'å–¶æ¥­æ™‚é–“: ' + place.opening_hours.weekday_text.join(', ');
      } else {
        document.getElementById('info-hours').textContent = 'å–¶æ¥­æ™‚é–“: æœªå–å¾—';
      }

      // é›»è©±ç•ªå·
      if (place.formatted_phone_number) {
        document.getElementById('info-phone').textContent = 'é›»è©±ç•ªå·: ' + place.formatted_phone_number;
      } else {
        document.getElementById('info-phone').textContent = 'é›»è©±ç•ªå·: æœªå–å¾—';
      }

      // Webã‚µã‚¤ãƒˆ
      if (place.website) {
        document.getElementById('info-website').innerHTML = 'Webã‚µã‚¤ãƒˆ: <a href="' + place.website + '" target="_blank">' + place.website + '</a>';
      } else {
        document.getElementById('info-website').textContent = 'Webã‚µã‚¤ãƒˆ: æœªå–å¾—';
      }

      // å†™çœŸ
      if (place.photos && place.photos.length > 0) {
        const photoUrl = place.photos[0].getUrl({ maxWidth: 400 });
        const photoElement = document.getElementById('place-photo');
        photoElement.src = photoUrl;
        photoElement.style.display = 'block';
      } else {
        const photoElement = document.getElementById('place-photo');
        photoElement.src = '';
        photoElement.style.display = 'none';
      }
    });
  }
</script>

<!-- Google Maps JS API èª­ã¿è¾¼ã¿ -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV["GOOGLE_MAPS_API_KEY"] %>&callback=initMap&libraries=places" async defer></script>
