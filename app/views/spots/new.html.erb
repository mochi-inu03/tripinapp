<%= form_with model: @spot, local: true do |f| %>

  <!-- â‘  ä½æ‰€æ¤œç´¢ -->
  <div style="margin-bottom: 10px;">
    <label for="address-input">ğŸ“ ä½æ‰€æ¤œç´¢</label><br>
    <input id="address-input" type="text" placeholder="ä¾‹: æ±äº¬é§…" style="width: 300px; padding: 5px;">
  </div>

  <!-- ç·¯åº¦ãƒ»çµŒåº¦ hidden_field -->
  <%= f.hidden_field :latitude, id: 'latitude' %>
  <%= f.hidden_field :longitude, id: 'longitude' %>

  <!-- â‘¡ ã‚¿ã‚¤ãƒˆãƒ« -->
  <div style="margin-bottom: 10px;">
    <%= f.label :title %><br>
    <%= f.text_field :title, style: "width: 300px; padding: 5px;" %>
  </div>

  <!-- â‘¢ èª¬æ˜ -->
  <div style="margin-bottom: 10px;">
    <%= f.label :description %><br>
    <%= f.text_area :description, rows: 4, style: "width: 300px; padding: 5px;" %>
  </div>

  <!-- â‘£ ç”»åƒ -->
  <div style="margin-bottom: 10px;">
    <%= f.label :image %><br>
    <%= f.file_field :image %>
  </div>

  <!-- â‘¤ ã‚«ãƒ†ã‚´ãƒª -->
  <div style="margin-bottom: 10px;">
    <%= f.label :category_id, "ã‚«ãƒ†ã‚´ãƒª" %><br>
    <%= f.collection_select :category_id, Category.all, :id, :name, prompt: 'é¸æŠã—ã¦ãã ã•ã„' %>
  </div>

  <!-- â‘¥ Google Map -->
  <div id="map" style="height: 400px; margin-bottom: 10px; border: 1px solid #ccc;"></div>

  <!-- â‘¦ æƒ…å ±ãƒ‘ãƒãƒ« -->
  <div id="info-panel">
    <strong>æ¤œç´¢çµæœ:</strong><br>

    <!-- å†™çœŸ -->
    <div id="info-photo" style="margin-bottom: 10px;">
      <img id="place-photo" src="" alt="å ´æ‰€ã®å†™çœŸ" style="max-width: 100%; display: none;">
    </div>

    <!-- ã‚¹ãƒãƒƒãƒˆå -->
    <div id="info-name" style="margin-bottom: 5px;">åå‰: æœªé¸æŠ</div>

    <!-- ä½æ‰€ -->
    <div id="info-address" style="margin-bottom: 5px;">ä½æ‰€: æœªé¸æŠ</div>

    <!-- å–¶æ¥­æ™‚é–“ -->
    <div id="info-hours" style="margin-bottom: 5px;">å–¶æ¥­æ™‚é–“: æœªå–å¾—</div>

    <!-- é›»è©±ç•ªå· -->
    <div id="info-phone" style="margin-bottom: 5px;">é›»è©±ç•ªå·: æœªå–å¾—</div>

    <!-- Webã‚µã‚¤ãƒˆ -->
    <div id="info-website" style="margin-bottom: 5px;">Webã‚µã‚¤ãƒˆ: æœªå–å¾—</div>
  </div>

  <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
  <%= f.submit "æŠ•ç¨¿ã™ã‚‹", style: "padding: 10px 20px; font-size: 16px;" %>

<% end %>

<!-- Google Maps JS API èª­ã¿è¾¼ã¿ -->
<script src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.dig(:google_maps, :api_key) %>&callback=initMap&libraries=places" async defer></script>

<!-- ã‚«ã‚¹ã‚¿ãƒ JSï¼ˆä¸‹ã«å…¥ã‚Œã¦OKï¼‰ -->
<script>
  let map;
  let marker;
  let autocomplete;
  let placesService;

  function initMap() {
    const initialPosition = { lat: 35.6803997, lng: 139.7690174 };
    map = new google.maps.Map(document.getElementById('map'), {
      center: initialPosition,
      zoom: 10
    });

    marker = new google.maps.Marker({
      map: map,
      position: initialPosition
    });

    // Autocomplete Service
    const input = document.getElementById('address-input');
    autocomplete = new google.maps.places.Autocomplete(input, {
      fields: [
        'geometry',
        'formatted_address',
        'place_id',
        'photos',
        'name',
        'opening_hours',
        'formatted_phone_number',
        'website'
      ]
    });

    placesService = new google.maps.places.PlacesService(map);

    // place_changed ã‚¤ãƒ™ãƒ³ãƒˆ
    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();

      if (!place.geometry || !place.geometry.location) {
        alert('å ´æ‰€ã®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }

      const location = place.geometry.location;
      map.setCenter(location);
      marker.setPosition(location);

      document.getElementById('latitude').value = location.lat();
      document.getElementById('longitude').value = location.lng();

      document.getElementById('info-name').textContent = 'åå‰: ' + (place.name || 'æœªå–å¾—');
      document.getElementById('info-address').textContent = 'ä½æ‰€: ' + (place.formatted_address || 'æœªå–å¾—');

      // å–¶æ¥­æ™‚é–“
      if (place.opening_hours && place.opening_hours.weekday_text) {
        const formattedHours = place.opening_hours.weekday_text.map(dayText => {
          const dayOfWeek = dayText.substring(0, 1);
          let dayClass = '';
          if (['åœŸ', 'æ—¥'].includes(dayOfWeek)) {
            dayClass = 'weekend';
          } else {
            dayClass = 'weekday';
          }
          return `<div class="hours-line ${dayClass}">${dayText}</div>`;
        }).join('');
        document.getElementById('info-hours').innerHTML = '<strong>å–¶æ¥­æ™‚é–“:</strong><div class="hours-card">' + formattedHours + '</div>';
      } else {
        document.getElementById('info-hours').innerHTML = '<strong>å–¶æ¥­æ™‚é–“:</strong> æœªå–å¾—';
      }

      // é›»è©±ç•ªå·
      if (place.formatted_phone_number) {
        document.getElementById('info-phone').textContent = 'é›»è©±ç•ªå·: ' + place.formatted_phone_number;
      } else {
        document.getElementById('info-phone').textContent = 'é›»è©±ç•ªå·: æœªå–å¾—';
      }

      // Webã‚µã‚¤ãƒˆ
      if (place.website) {
        document.getElementById('info-website').innerHTML = 'Webã‚µã‚¤ãƒˆ: <a href="' + place.website + '" target="_blank">' + place.website + '</a>';
      } else {
        document.getElementById('info-website').textContent = 'Webã‚µã‚¤ãƒˆ: æœªå–å¾—';
      }

      // å†™çœŸ
      if (place.photos && place.photos.length > 0) {
        const photoUrl = place.photos[0].getUrl({ maxWidth: 400 });
        const photoElement = document.getElementById('place-photo');
        photoElement.src = photoUrl;
        photoElement.style.display = 'block';
      } else {
        const photoElement = document.getElementById('place-photo');
        photoElement.src = '';
        photoElement.style.display = 'none';
      }
    });
  }
</script>
